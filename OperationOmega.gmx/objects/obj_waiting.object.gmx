<!--This Document is generated by GameMaker, if you edit it by hand then you do so at your own risk!-->
<object>
  <spriteName>&lt;undefined&gt;</spriteName>
  <solid>0</solid>
  <visible>-1</visible>
  <depth>0</depth>
  <persistent>0</persistent>
  <parentName>&lt;undefined&gt;</parentName>
  <maskName>&lt;undefined&gt;</maskName>
  <events>
    <event eventtype="0" enumb="0">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>//Match info update timer
updatenow = 10;
//Restart the correct music
audio_stop_all();
if(global.musictoggle = 0)
{
    audio_stop_all();        
    audio_play_sound(music_lunation, 1, 1);
}

//Initilize chat
chat_init(8);

flashing = '|';
alarm[0] = 12;
if(room = rm_waiting)
{
    for(i = 0; i &lt; 8; i += 1)
    {
        global.playerprimary[i] = 0;
        global.playerslot[i] = instance_create(626, 27+(i*31), obj_playerslot);
        global.playerslot[i].mid = i;
        global.playerslot[i].active = 0;
        global.playerslot[i].alarm[1] = 20+i*5;
        if(i &gt; 0 &amp;&amp; global.create_postgame_popup = false)
        {
           global.othername[i] = "";
           global.activated[i] = 0;
        }
        global.readied[i] = 1;
    }
}
global.readied[0] = 3;

global.playerslot[0].active = 1;
global.playerslot[0].team = global.team[global.mymid];
global.playerslot[0].ship = global.shipselect;
global.playerslot[0].ready = 1;
global.playerslot[0].name = global.name;
global.activated[0] = 1;
(instance_create(global.playerslot[0].x, global.playerslot[0].y, obj_playerslot_readied)).mid = 0;

//Create the postgame popup if it's called for
if(global.create_postgame_popup = true)
{
    global.create_postgame_popup = false;
    instance_create(384, 240, obj_postgame_box);
}


//Set stock match elimination values
global.redteamout = 0;
global.blueteamout = 0;

         if(global.public_game = true)
         {
 
          if(global.playercount = global.maxplayers)
            roomstatus = "Full";
          else
            roomstatus = "Waiting";
          global.createtime = get_servertime();
          sql_modify(global.myipaddress, global.createtime, global.maxplayers, global.playercount, global.matchtype, global.shortlevel, roomstatus);
}
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="2" enumb="0">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>//Change the flashing text
if(flashing = ' ')
 flashing = '|';
else
 flashing = ' ';
//Set time until next flash
alarm[0] = 18;
</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="3" enumb="0">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>global.selected_ship[0] = global.shipselect;
global.playerprimary[0] = global.primary;
//Calculate max players
global.maxplayers = 0;
for(i = 0; i &lt; 8; i += 1)
{
 if(global.activated[i] != -1)
  global.maxplayers += 1;
}

if(ds_list_size(global.clients) &gt; 0)
while(true)
 {
  //var packet, size;
  size = 0;
  for(i = 0; i &lt; ds_list_size(global.clients); i += 1)
  {
   size = receivemessage(client_port(i), 0, 0);
   //If a message was received, break the loop
   if(size &gt; 0) break;
  }
  if(size &lt; 0) break;
  if(size = 0) break;///////////////////////
  packet = readbyte(0);
   switch(packet)
   {
   
    //Check for new chat messages
    case 11:
         var new_chat_mid = readbyte(0);
         var new_chat_line = readstring(0);
         var new_chat_color = readbyte(0);
         if(new_chat_mid = global.mymid)
            break;
         chat_addline(new_chat_line, new_chat_color, 1, new_chat_mid);
    break;
    
    //A new player joins
    case 12:
         audio_play_sound(snd_playerjoin, 1, 0);
         mid = readbyte(0);
         newteam = readbyte(0);
         global.othername[mid] = readstring(0);
         global.selected_ship[mid] = readbyte(0);
         //Update the info on the games list
         if(global.public_game = true)
         {
          if(ds_list_size(global.clients)+1 = global.maxplayers)
            roomstatus = "Full";
          else
            roomstatus = "Waiting";
          global.createtime = get_servertime();
          sql_modify(global.myipaddress, global.createtime, global.maxplayers, ds_list_size(global.clients)+1, global.matchtype, global.shortlevel, roomstatus);
         }
         //Send a notice to chats
         chat_addline(global.othername[mid]+" has joined the game.", 1, 1, 0);

    break;

    
    //A player clicks ready
    case 13:
         //Send a notice to your chat
         var newchat = readstring(0);
         //Update the players' ready status
         var thisplayer = readbyte(0);
         global.selected_ship[thisplayer] = readbyte(0);
         global.playerprimary[thisplayer] = readbyte(0);
         var readystat = readbyte(0);
         global.readied[thisplayer] = readystat;
         audio_play_sound(snd_readyup, 1, 0);
         if(readystat = 2)
                (instance_create(global.playerslot[thisplayer].x, global.playerslot[thisplayer].y, obj_playerslot_readied)).mid = thisplayer;
         else
            with(obj_playerslot_readied)
                if(mid = readystat)
                    instance_destroy();
         //Send a notice to everyone else
         chat_addline(newchat, 1, 1, 0);

    break;
    
    //A player changes teams
    case 14:
          global.redteam = readbyte(0);
          global.blueteam = readbyte(0);
          lolplayer = readbyte(0);
          (instance_create(global.playerslot[lolplayer].x, global.playerslot[lolplayer].y, obj_playerslot_teamchange)).image_index = global.selected_ship[lolplayer]+((global.team[lolplayer]-1)*3)-1;
          global.team[lolplayer] = readbyte(0);
    break;
   
    //A player changes ships
    case 17:
         mid = readbyte(0);
         global.selected_ship[mid] = readbyte(0);
    break;
    
    //Post-match stat send
    case 18:
        mid = readbyte(0);
        for(i = 0; i &lt; 8; i += 1)
        {
            global.assists[i] += readbyte(0);
            global.damagedealt[i] += readshort(0);
        }
        global.damagetaken[mid] = readshort(0);
        global.walldeaths += readbyte(0);
        global.walldamage += readshort(0);
        client_sendall(0, mid);
    break;

        //A client has quit
    case CLIENT_DROP:
         audio_play_sound(snd_playerleave, 1, 0);
         //Get info from leaving player
         mid = readbyte(0);
         droppedname = readstring(0);

         //Drop the player and add the drop to the count
         client_drop(mid);
         //Update the info on the games list
         if(global.public_game = true)
         {
            global.createtime = get_servertime();
            sql_modify(global.myipaddress, global.createtime, global.maxplayers, ds_list_size(global.clients)+1, global.matchtype, global.shortlevel, "Waiting");
         }
        global.newmid = mid;    
        with(obj_playerslot)
        {
            if(mid = global.newmid)
            {
                playerleave = instance_create(x, y, obj_playerslot_playerleave);
                playerleave.owner = id;
                playerleave.lastimage = global.selected_ship[mid]+((global.team[mid]-1)*3)-1;
                visible = 0;
            }
        }         
         //Send a notice to all chats
         chat_addline(droppedname+" has left the game.", 1, 1, 0);

    break;
   }
  }

//Send the constant update
if(updatenow = 0)
{
    clearbuffer(0);
    writebyte(CLIENT_CHECK, 0);
    writebyte(ds_list_size(global.clients)+1, 0);
    global.playercount = ds_list_size(global.clients)+1;
    writebyte(global.maxplayers, 0);
    writestring(global.matchtype, 0);
    writebyte(global.matchvariable, 0);
    writestring(global.matchlevel, 0);
    for(i = 0; i &lt;= 7; i += 1)
    {
     writebyte(global.activated[i], 0);
     if(global.activated[i] = 1)
     {
      writestring(global.othername[i], 0);
      writebyte(global.team[i], 0);
      writebyte(global.selected_ship[i], 0);
      writebyte(global.readied[i], 0);
     }
    }
    writebyte(global.redteam, 0);
    writebyte(global.blueteam, 0);
    client_sendall(0, 0);
    updatenow = 10;
}
else
    updatenow -= 1;

if(room = rm_aftergame) exit;
if(!instance_exists(obj_readygo)) exit;
if(obj_readygo.go = 7) exit;
//Listen for a new player
newclient = tcpaccept(global.listen, true);
//Accept new players if there is room
if(global.maxplayers &gt; ds_list_size(global.clients)+1)
{
    //Abort if no new player
    if(newclient &lt;= 0) exit;
    //Add the player to the client list
    mid = client_add(newclient);
    
    //Activate their player slot and set their ready status
    global.activated[mid] = 1;
    global.readied[mid] = 1;
    
    global.newmid = mid;    
    with(obj_playerslot)
    {
        if(mid = global.newmid)
        {
            showthisimage = 0;
            (instance_create(x, y, obj_playerslot_addplayer)).owner = id;
        }
    }
    
    
    //Tell them they were accepted, give them their mid and other important info
    clearbuffer(0);
    writebyte(CLIENT_ACCEPT, 0);
    writebyte(mid, 0);
    writebyte(ds_list_size(global.clients)+1, 0);
    writebyte(global.maxplayers, 0);
    //Give them a team
    if(global.redteam &gt; global.blueteam) 
    {
        writebyte(2, 0);
        global.blueteam += 1;
        global.team[mid] = 2;
    }
    else 
    {
        writebyte(1, 0);
        global.redteam += 1;
        global.team[mid] = 1;
    }
    //send it all
    sendmessage(newclient, 0, 0, 0);
}
else
{
 //Reject the new player if there is no room
 clearbuffer(0);
 writebyte(CLIENT_REJECT, 0);
 sendmessage(newclient, 0, 0, 0);
}

</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="8" enumb="0">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>draw_set_font(fnt_chat);
if(instance_exists(obj_customizer))
    draw_set_alpha(obj_customizer.backbox.display_alpha);
else
    draw_set_alpha(1);

//Stop more input if max is reached
if(string_length(keyboard_string) &gt; 90)
 keyboard_string = string_copy(keyboard_string, 0, 90);
      
//Undo same-letter spams
lastletter = string_copy(keyboard_string, string_length(keyboard_string), 1);
keyboard_string = string_replace(keyboard_string, lastletter+lastletter+lastletter+lastletter, lastletter+lastletter+lastletter);
      
//Undo '#'
keyboard_string = string_replace(keyboard_string, '#', '');
      
//Limit the length of the message
while(string_width(global.myname+": "+keyboard_string) &gt; 350)
    keyboard_string = string_copy(keyboard_string, 0, string_length(keyboard_string)-1);

//Draw the text in the chat bar
draw_text_bordered(6, 455, keyboard_string+flashing, 1, 1, c_black, c_white);

//draw chat
for(i = 0; i &lt;= 7; i += 1)
{
 draw_text_bordered(2, 407-(i*18), chat_line[8-i], 1, 1, c_black, chat_color[8-i]);
}
draw_set_alpha(1);

</string>
          </argument>
        </arguments>
      </action>
    </event>
    <event eventtype="9" enumb="13">
      <action>
        <libid>1</libid>
        <id>603</id>
        <kind>7</kind>
        <userelative>0</userelative>
        <isquestion>0</isquestion>
        <useapplyto>-1</useapplyto>
        <exetype>2</exetype>
        <functionname></functionname>
        <codestring></codestring>
        <whoName>self</whoName>
        <relative>0</relative>
        <isnot>0</isnot>
        <arguments>
          <argument>
            <kind>1</kind>
            <string>  if(keyboard_string = '') exit;
  audio_play_sound(snd_chatmessage, 1, 0);
  //create the new chat line and take note of its middle
  sendline = global.name+": "+ keyboard_string;
  middle = floor(string_length(sendline)/2);
  //Break up text if there is no space near the middle
  if(string_replace(string_copy(sendline, middle-4, 8), ' ', '-') = string_copy(sendline, middle-4, 8) &amp;&amp; string_length(sendline) &gt; 30)
   sendline = string_insert(' ', sendline, middle);
    
chat_addline(sendline, 0, 1, global.mymid);
keyboard_string = "";
</string>
          </argument>
        </arguments>
      </action>
    </event>
  </events>
  <PhysicsObject>0</PhysicsObject>
  <PhysicsObjectSensor>0</PhysicsObjectSensor>
  <PhysicsObjectShape>0</PhysicsObjectShape>
  <PhysicsObjectDensity>0.5</PhysicsObjectDensity>
  <PhysicsObjectRestitution>0.100000001490116</PhysicsObjectRestitution>
  <PhysicsObjectGroup>0</PhysicsObjectGroup>
  <PhysicsObjectLinearDamping>0.100000001490116</PhysicsObjectLinearDamping>
  <PhysicsObjectAngularDamping>0.100000001490116</PhysicsObjectAngularDamping>
  <PhysicsObjectFriction>0.200000002980232</PhysicsObjectFriction>
  <PhysicsObjectAwake>-1</PhysicsObjectAwake>
  <PhysicsObjectKinematic>0</PhysicsObjectKinematic>
  <PhysicsShapePoints/>
</object>
